<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Compute - Agate examples</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../extra.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Compute";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Agate examples</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../imports/">Imports</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../filters/">Filters</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Compute</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#new-columns-using-compute">New columns: Using .compute()</a></li>
                
                    <li><a class="toctree-l4" href="#zfill-fix-zero-padded-ids">zfill: Fix zero-padded IDs</a></li>
                
                    <li><a class="toctree-l4" href="#mapped-translation">Mapped translation</a></li>
                
                    <li><a class="toctree-l4" href="#converting-timezones">Converting timezones</a></li>
                
                    <li><a class="toctree-l4" href="#rewrite-datetime-in-another-format">Rewrite date/time in another format</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../sort/">Sorting</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Agate examples</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Compute</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="new-columns-using-compute">New columns: Using .compute()</h1>
<p>Creating new columns based on something in the data.</p>
<p>This extends the <a href="http://agate.readthedocs.io/en/1.6.0/cookbook/compute.html">.compute() examples</a></p>
<h2 id="zfill-fix-zero-padded-ids">zfill: Fix zero-padded IDs</h2>
<p>In school data from TEA, the <code>Campus_ID</code> column is supposed to be a 9-digit column, and any school that is less than that should have zeros at the beginning. Sometimes .csv files saved from Excel loose this zero padding, but we can replace it:</p>
<pre><code>  zfilled = nodistrict.compute([
      ('New_Campus_ID', agate.Formula(agate.Text(), lambda r: r['CAMPUS'].zfill(9))),
      ('New_District_ID', agate.Formula(agate.Text(), lambda r: r['DISTRICT'].zfill(6)))
  ])
</code></pre>

<p>For the first one, we created <code>New_Campus_ID</code> by going through the <code>Campus</code> column and using the Python method <code>.zfill()</code> to set pad any <code>Campus</code> that wasn't 9 characters. For  <code>['District']</code> we used "6".</p>
<h2 id="mapped-translation">Mapped translation</h2>
<p>We wanted to create a new field that inserts the longer explanation based on the a one-letter designation in the data.</p>
<p>First we have the map:</p>
<pre><code class="python">  rating_map = {
      'I': 'Improvement required',
      'M': 'Met standard',
      'A': 'Met alternative standard',
      'X': 'Not rated',
      'Z': 'Not rated',
      '': 'Not rated'
  }
</code></pre>

<p>Then we need a function that we will run the compute through to get the proper rating match:</p>
<pre><code class="python">  def map_rating(rating):
      rating = rating.strip()
      return rating_map[rating]
</code></pre>

<p>Then we create the new table. We are looking at the field <code>C_RATING</code> for the single-letter values. (This was originally used as a method on an export command, so it should be tested in this configuration):</p>
<pre><code class="python">  rated = unrated.compute([
      ('mapped_rating',
       agate.Formula(agate.Text(),
       lambda r: map_rating(r['C_RATING']))
      )
  ])
</code></pre>

<p>In then end, we have a new column called <code>mapped_rating</code> that includes values like "Met Standard".</p>
<h2 id="converting-timezones">Converting timezones</h2>
<p>I had data that came in UTC time, but I wanted to display it in Central Time. You first need to make sure your datatime is not naive and has a timezone, perhaps when <a href="#add-timezone-to-a-date">you import it</a>.</p>
<p>In this case, I had a field <code>dateTime</code> that was in UTC, that I need to convert to Central Time. This requires  the <a href="http://pytz.sourceforge.net/index.html?highlight=list%20timezones#">pytz library</a>, as well:</p>
<pre><code class="python">  ## Import pytz if you don't already have it
  import pytz

  ## setting central time
  central = pytz.timezone('US/Central')

  ## formula to do the conversion from the 'dateTime' field
  time_shifter = agate.Formula(
    agate.DateTime(),
    lambda r: r['dateTime'].astimezone(central)
    )

  ## create column and call the formula above
  flow_central = flow_data.compute([
          ('Central Time', time_shifter),
      ])
</code></pre>

<p>This gives me the new column <code>Central Time</code>.</p>
<h2 id="rewrite-datetime-in-another-format">Rewrite date/time in another format</h2>
<p>I had a case where Tableau did not understand the "native" datetime format (2017-08-26 22:00:00-05:00) that was exported to csv, so I had to create a new "pretty" date column (2017-08-26 22:00:00). I had lots of challenges because I could not format both a time and date <code>.stftime()</code> from the <code>.date()</code> method, nor the <code>.time()</code> method. It would only understand it's own type. So, I created strings of the date and the time and then put them together. Since I was exporting, it didn't matter that it was text and not a true datetime object.:</p>
<pre><code class="python">  # create a tableau-friendly date
  flow_central = flow_central.compute([
          ('Measurement time', agate.Formula(agate.Text(),
                                       lambda r: str(r['CentralTime'].date())\
                                       + &quot; &quot; \
                                       + str(r['CentralTime'].time()))) 
      ])
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../sort/" class="btn btn-neutral float-right" title="Sorting"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../filters/" class="btn btn-neutral" title="Filters"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../filters/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../sort/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
